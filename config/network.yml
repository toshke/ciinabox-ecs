stacks:
  test:
    subnet_allocation: 15


loadbalancers:
  -
    name: LocustMaster
    records:
      - locust
    idle_timeout: 120
    master_targetgroup:
      healthcheck:
        path: '/'
      port: 80
    listeners:
      -
        name: http
        port: 80
        protocol: http
      -
        name: https
        port: 443
        protocol: https
  -
    name: LocustSlaveNetwork
    records:
      - locustMaster
    type: network
    internal: true
    slave_targetgroup:
      healthcheck:
        protocol: tcp
        threshold_count: 3
      port: 80
      protocol: tcp
    listeners:
      -
        name: tcp
        port: 5557
        protocol: tcp

securityGroups:
  LocustMaster:
    -
      rules:
        -
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        -
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
      ips:
        - 0.0.0.0/0
  LocustSlaveNetwork:
    -
      rules:
        -
          IpProtocol: tcp
          FromPort: 80
          ToPort: 80
        -
          IpProtocol: tcp
          FromPort: 5557
          ToPort: 5558
      ips:
        - stack

targetgroups:
  locustmaster:
    loadbalancer: LocustMaster
    healthcheck:
      path: '/'
    listeners:
      - http
    conditions:
      - host: 'locust.*'
    priority: 12
  locustMaster:
    loadbalancer: LocustSlaveNetwork
    healthcheck:
      protocol: tcp
      port: 5557
    protocol: tcp